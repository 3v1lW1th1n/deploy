# primer/deploy

This GitHub Action deploys to [Now] and aliases the successful deployment to a predictable URL according to the following conditions:

1. We run `now` without any arguments to get the "root" deployment URL, which is generated by Now.
1. If the branch is `master`, we treat the `alias` field in `now.json` as the production URL and:
    1. If there is a `rules.json`:
        * `now alias <deployment> <name>.now.sh` to create a fallback URL for path aliases
        * `now alias <deployment> <production> -r rules.json` to set up path aliases
    1. `now alias <deployment> <production>` to alias the production URL.
1. `now alias <deployment> <name>-<branch>.now.sh` to alias the root deployment to a branch-specific URL.

The app name (`<name>`) and branch (`<branch>`) are both "slugified" to strip invalid characters so that they'll work as URLs. Leading non-word characters are removed, and any sequence of characters that isn't alphanumeric or `-` is replaced with a single `-`. In other words, `@primer/css` becomes `primer-css`, `shawnbot/some_branch` becomes `shawnbot-some-branch`, and so on.

## Usage
To use this action in your own workflow, add the following snippet to your `.github/main.workflow` file:

```hcl
action "deploy" {
  uses = "primer/deploy@master"
  secrets = [
    "GITHUB_TOKEN",
    "NOW_TOKEN",
  ]
}
```

**You will need to provide a [Zeit token](https://zeit.co/account/tokens) value for the `NOW_TOKEN` secret in the Actions visual editor** if you haven't already set one up.

To avoid racking up failed deployments, we suggest that you place this action after any linting and test actions.

## Now CLI arguments
It's possible to pass additional arguments through to the `now` CLI by passing them after a `--` in the positional arguments to the entrypoint (or, if you're running this from an npm installation, the `primer-deploy` CLI). However, due to a known issue with the `args` field in workflow files, you have to use `runs` like so:

```diff
action "deploy" {
  uses = "primer/deploy@master"
-  args = "-- --meta foo=bar"
+  runs = "/entrypoint.js -- --meta foo=bar"
  secrets = [
    "GITHUB_TOKEN",
    "NOW_TOKEN",
  ]
}
```

[Now]: https://zeit.co/now
